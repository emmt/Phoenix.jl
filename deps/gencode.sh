#! /bin/sh
#
# gencode.sh --
#
# Bash script to generate Julia contants for the Activision Phoenix frame
# grabber library.
#
#-------------------------------------------------------------------------------
#
# This file is part of the `Phoenix.jl` package which is licensed under the MIT
# "Expat" License.
#
# Copyright (C) 2017-2019, Éric Thiébaut (https://github.com/emmt/Phoenix.jl).
#

if test $# != 1; then
   echo >&2 "Usage: $0 DEST"
   exit 1
fi
DEST=$1

COMMAND=./gencode

if ! test -x "$COMMAND"; then
   echo >&2 "Error: command '$COMMAND' is not an executable."
   exit 1
fi

# Generate header.
cat >"$DEST" <<'EOF'
#
# deps.jl --
#
# Definitions of types and constants for interfacing ActiveSilicon Phoenix
# (PHX) library with Julia.
#
# *DO NOT EDIT* as this file is automatically generated for your machine.
#
#------------------------------------------------------------------------------
#
# This file is part of the `Phoenix.jl` package which is licensed under the MIT
# "Expat" License.
#
# Copyright (C) 2017-2019, Éric Thiébaut (https://github.com/emmt/Phoenix.jl).
#

# Abstract (i.e., non-instanciable) types used to indicate whether
# read and/or write access is granted.
abstract type AccessMode end
abstract type Unreachable <: AccessMode end
abstract type ReadOnly    <: AccessMode end
abstract type WriteOnly   <: AccessMode end
abstract type ReadWrite   <: AccessMode end
const Readable = Union{ReadWrite,ReadOnly}
const Writable = Union{ReadWrite,WriteOnly}


# Export prefixed constants.
export
EOF

# First pass to generate list of exported symbols.
$COMMAND | sed -n -r >>"$DEST" \
               -e 's/[ \t]+/ /g' \
               -e '/^ *const PHX_/!d' \
               -e 's/^ *const (PHX_[_A-Z0-9]*).*/    \1,/' \
               -e 'H' \
               -e '${x;s/^[ \n]*/    /;s/,[ \n]*$//;p}'

# Second pass to generate code and definitions.
$COMMAND >>"$DEST"
